# Veris ZK Integration Guide
## Upgrading from commit-reveal to real Groth16 proofs

---

## What you're getting

| Before (V1)              | After (V2)                        |
|--------------------------|-----------------------------------|
| keccak256 commitment     | Poseidon hash commitment          |
| No ZK proof              | Real Groth16 proof                |
| Off-chain verification   | ON-CHAIN proof verification       |
| ~0 constraints           | ~240 constraints (fast!)          |
| "ZK-style"               | Actual zero-knowledge             |

The math: agent proves *"I know a salt S such that Poseidon(price, ts, S) = commitment"*
without ever revealing S. The Groth16 verifier checks elliptic curve pairings on-chain.

---

## Step 1 â€” Install circom

```bash
cd ~/verisafe

# Install snarkjs and circomlib
npm install snarkjs circomlib

# Install circom compiler (Rust-based)
# Option A: if you have cargo (Rust)
cargo install circom

# Option B: download binary directly
curl -L https://github.com/iden3/circom/releases/download/v2.1.8/circom-linux-amd64 -o /tmp/circom
chmod +x /tmp/circom
sudo mv /tmp/circom /usr/local/bin/circom

# Verify
circom --version
# Should show: circom compiler 2.1.8
```

---

## Step 2 â€” Copy new files into your repo

Copy these files from the ZK package into `~/verisafe/`:

```
circuits/price_commitment.circom   â†’ ~/verisafe/circuits/price_commitment.circom
circuits/setup.sh                  â†’ ~/verisafe/circuits/setup.sh
backend/zk/groth16-prover.js       â†’ ~/verisafe/backend/zk/groth16-prover.js
src/VerisOracleV2.sol              â†’ ~/verisafe/src/VerisOracleV2.sol
script/DeployVerifier.s.sol        â†’ ~/verisafe/script/DeployVerifier.s.sol
oracle-agent-zk.js                 â†’ ~/verisafe/oracle-agent-zk.js
```

---

## Step 3 â€” Run the trusted setup (one-time, ~5-10 min)

```bash
cd ~/verisafe
bash circuits/setup.sh
```

This will:
1. Compile the circuit â†’ generates `.r1cs` + `.wasm`
2. Download Hermez Powers of Tau (trusted ceremony, used in production)
3. Run circuit-specific setup â†’ generates `.zkey`
4. Export `src/Groth16Verifier.sol` â† this is the on-chain verifier
5. Run a test proof to confirm everything works

When done you'll see:
```
âœ… SETUP COMPLETE â€” ZK CIRCUIT READY
```

---

## Step 4 â€” Test proof generation

```bash
cd ~/verisafe
node backend/zk/groth16-prover.js --test
```

Expected output:
```
1. Generating proof for $616.51...
[ZK Prover] Proof generated in 2.3s
[ZK Prover] Commitment: 0x1a2b3c...

2. Verifying proof locally...
   Valid: âœ… YES

3. What gets published on-chain:
   Price (public):      $616.51
   Timestamp (public):  1772197104
   Commitment (output): 0x1a2b3c...
   Proof size:          ~256 bytes (Groth16)
```

---

## Step 5 â€” Deploy Groth16Verifier + VerisOracleV2

```bash
cd ~/verisafe
source .env

# Build (includes Groth16Verifier.sol generated by setup.sh)
forge build

# Deploy
forge script script/DeployVerifier.s.sol \
  --rpc-url https://bsc-testnet-rpc.publicnode.com \
  --private-key $PRIVATE_KEY \
  --broadcast
```

Copy the printed addresses into `.env`:
```
GROTH16_VERIFIER=0x...
VERIS_ORACLE_V2=0x...
```

---

## Step 6 â€” Submit first real ZK proof

```bash
cd ~/verisafe
source .env
node oracle-agent-zk.js
```

Expected output:
```
ğŸ”® VERIS ORACLE AGENT V2 â€” Real ZK Proofs

[Veris V2] Live BNB/USD from Binance: $614.20
[Veris V2] Step 1: Generating Groth16 ZK proof...
[ZK Prover] Proof generated in 2.4s
[ZK Prover] Commitment: 0xabc123...
[Veris V2] Step 2: Verifying proof locally...
[Veris V2] âœ… Proof verified locally
[Veris V2] Step 3: Submitting proof on-chain...
[Veris V2] TX hash: 0xdef456...
[Veris V2] âœ… Groth16 proof verified ON-CHAIN

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  âœ… REAL ZK PROOF SUBMITTED ON-CHAIN  â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  Price:      $614.20
â•‘  Protocol:   Groth16 BN128
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

## What to say to judges

**"Is this real ZK?"**

> "Yes. We use a Groth16 proof over BN128. The circuit is ~240 Poseidon constraints.
> The agent proves it knows a secret salt such that Poseidon(price, timestamp, salt)
> equals the published commitment â€” without ever revealing the salt.
> The Groth16Verifier contract checks elliptic curve pairings on-chain.
> The full proof and witness are anchored to BNB Greenfield for permanent auditability.
> keccak256 would need 28,000 constraints. Poseidon is why production ZK systems â€”
> Tornado Cash, Zcash â€” use it instead."

**"Why Poseidon and not keccak256?"**

> "keccak256 requires ~28,000 R1CS constraints in circom. Proof generation takes
> minutes. Poseidon is an algebraically structured hash designed for ZK systems â€”
> it needs ~240 constraints. Same security, 100x faster proof generation.
> It's the standard in production ZK: Zcash, Aztec, Tornado Cash all use it."

**"What's on BNB Greenfield?"**

> "Every proof submission saves the full Groth16 proof, the public signals,
> and the secret witness (salt encrypted) to a Greenfield bucket. The on-chain
> oracle stores the Greenfield object ID. Anyone can fetch the proof from Greenfield
> and verify it independently. That's the audit trail no other chain can provide â€”
> permanent, immutable, smart-contract-controlled."

---

## Troubleshooting

**"circom: command not found"**
```bash
cargo install circom
# or: see Step 1 binary download option
```

**"Circuit WASM not found"**
```bash
bash circuits/setup.sh   # run the full setup first
```

**"Proof verification failed"**
- Usually means ZKEY and WASM are from different compilation runs
- Delete `circuits/build/` and re-run `setup.sh`

**"Transaction reverted: InvalidZKProof"**
- The proof was generated for different public inputs than what was submitted
- Check price and timestamp match between proof generation and submission
- Ensure VERIS_ORACLE_V2 address is set (not the V1 address)

---

## Architecture summary

```
Off-chain (Veris Agent)           On-chain (BSC)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Fetch BNB/USD                     Groth16Verifier.sol
  â†“                                 (snarkjs-generated)
Generate random salt                    â†‘
  â†“                               verifyProof(a, b, c, [commitment, price, ts])
Poseidon(price, ts, salt)              â†‘
  â†’ commitment                    VerisOracleV2.sol
  â†“                                 submitPriceWithProof(...)
Groth16.prove(circuit, input)       if !verifier.verify() â†’ revert
  â†’ proof (a, b, c)                 else store price âœ…
  â†“
saveToGreenfield(proof, witness)
  â†“
Submit TX to VerisOracleV2
  â†’ Solidity checks proof on-chain
```
